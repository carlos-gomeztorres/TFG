---
title: "Valoración deportivo-financiera de equipos de fútbol mediante aprendizaje
  automático"
author: "Carlos Gómez-Torres"
date: "8 de Septiembre, 2024"
output:
  pdf_document: default
  html_document: default
  word_document: default
subtitle: Trabajo de Fin de Grado
header-includes:
    - \usepackage{caption}
---

\captionsetup[table]{labelformat=empty}

```{r setup, include=FALSE}
# Configuración global para todos los chunks
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	results = "hold",
	fig.align = "center"
)
```

# Conjunto de datos

Para los objetivos de este estudio, se pretendía construir un conjunto de datos con variables financieras y deportivas alrededor de los 200 equipos de fútbol participantes en las competiciones de primera y segunda división en España, Inglaterra, Italia, Alemania y Francia durante la campaña 2023/2024. En concreto, la información financiera (balance de situación, cuenta de pérdidas y ganancias, y transacciones de M&A) se extraería de la base de datos ORBIS de Bureau van Dijk, y la información deportiva del portal web Transfermarkt, abarcando los años en el periodo 2009-2023.

### ORBIS

En un principio, se intentó un filtrado en ORBIS con palabras clave y códigos identificadores del sector. Sin embargo, el listado resultante no era completo, además de incluir equipos de otros deportes (algunos relacionados con equipos de fútbol, como el Real Madrid Baloncesto), así como otras organizaciones controladas por equipos de fútbol, como lo son las fundaciones benéficas. 

De manera que, se buscó manualmente cada club en la base datos con el fin de obtener sus identificadores y filtrar en base a los mismos. En este proceso, se encontró que una porción de los clubes no estaban presentes en la base de datos. En concreto, se lograron identificar 142 equipos. No obstante, la información de las cuentas anuales de interés no estaba presente o completa para todos los años.

Con el fin de tener la mayor cantidad de datos posibles, se buscó manualmente auditorías y reportes anuales de los equipos. En el caso de los equipos ingleses, al ser sociedades limitadas, se encontraron sus auditorías en el portal web del registro mercantil del Reino Unido. Para el resto de equipos, se llevó a cabo una búsqueda exhaustiva en sus páginas web correspondientes. Este procedimiento permitió añadir datos de 30 equipos más, para un total de 172 equipos.

### Transfermarkt
Por otro lado, de Transfermarkt.com se extrajo información acerca del rendimiento deportivo de los equipos (división en la que compitieron, posición conseguida, partidos ganados, goles a favor y en contra, etc) y su actividad en el mercado de transferencia.

```{r load}
# Carga de ficheros:
library(rio)
library(here)

# Data wrangling:
library(tidyverse)

# SOM:
library(kohonen)

# ANOVA / post-hoc tests:
library(agricolae)

# Visualización:
library(corrplot)
library(viridis)
library(DT)
library(kableExtra)
library(patchwork)

# Funciones de usuario:
source(here('./scripts/winsorize.R'))
source(here('./scripts/anova_tests.R'))
source(here('./scripts/neuron_distance_ratio.R'))
source(here('./scripts/addFig.R'))
source(here('./scripts/addTab.R'))

# Inicialización parámetros de figuras
nFig <- 0
nTab <- 0
par(mar = c(1,1,10,1))

# Carga de datos
Transfermarkt <- import(here('./data/processed/Transfermarkt.xlsx'))
Finanzas <- import(here('./data/processed/Finanzas.xlsx'))

Deals <- import(here('./data/processed/M&A.xlsx')) %>%
  filter(!is.na(VALOR), !is.na(PART))

df <- inner_join(Finanzas, Transfermarkt, by = c("EQUIPO","AÑO")) %>%
  select(EQUIPO,
         PAIS,
         AÑO,
         MATERIAL, 
         INGRESOS,
         EBIT,
         MV,
         MV5,
         FICHAJES,
         CAPACIDAD,
         ASISTENCIA,
         OCUPACION,
         RANKNAC,
         RANKNAC5,
         WINPCT,
         WINPCT5)
```

### Variables

Para el análisis, se seleccionaron variables clave del conjunto de datos de ORBIS y Transfermarkt. De las cuentas anuales, se conservaron tres variables: la cifra de inmovilizado material, los ingresos de explotación y el beneficio antes de intereses y después de impuestos. Paralelamente, del conjunto de datos de Transfermarkt, se extrajeron para cada temporada el valor de mercado agregado de la plantilla, el gasto en fichajes, la capacidad máxima del estadio y la asistencia media al estadio. Adicionalmente, se calcularon el ranking nacional del equipo, definido como el percentil de la posición del equipo en relación con todas las posiciones entre la primera y la tercera división, y el porcentaje de victorias en liga sobre el total de partidos jugados. Ambas métricas se calcularon también como medias móviles con una ventana de 5 años.

El glosario con los nombres abreviados escogidos y las descripciones correspondientes para todas estas variables se detallan en la Tabla 1.

```{r glosario}
desc <- c("Nombre del equipo",
  "País de la liga en la que compite el equipo",
  "Año al que corresponden los datos financieros y deportivos",
  "Cifra del inmovilizado material",
  "Cifra de ingresos de explotación",
  "Cifra del beneficio antes de impuestos e intereses",
  "Valor de mercado agregado de la plantilla, según Transfermarkt.com",
  "Media del valor agregado de la plantilla en los últimos 5 años",
  "Gasto total en fichajes durante la temporada",
  "Capacidad máxima del estadio",
  "Número de espectadores medio en partidos locales durante la temporada",
  "Media del porcentaje de ocupación del estadio durante la temporada",
  "Ranking nacional del equipo (percentil de posición en liga sobre las divisiones 1-3)",
  "Media del ranking nacional en los últimos 5 años",
  "Porcentaje de partidos ganados en liga durante la temporada",
  "Media del porcentaje de partidos ganados en liga durante los últimos 5 años")

data.frame(Alias = names(df), Descripción = desc) %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE,
        caption = nameTab("Glosario de variables")) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
df <- filter(df, AÑO != 2020)

df %>%
  group_by(País = PAIS) %>%
  summarise(N = n(),`%` = round(100*N/nrow(df),2)) %>%
  kable(format = "latex", 
        booktabs = TRUE,
        caption = nameTab("Nº de observaciones por país")) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
Deals %>%
  inner_join(df) %>%
  group_by(País = PAIS) %>%
  summarise(N = n(),`%` = round(100*N/nrow(Deals),2)) %>%
  kable(format = "latex", 
        booktabs = TRUE,
        caption = nameTab("Nº de transacciones por país")) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r}
#df %>% 
#  arrange(EQUIPO, AÑO) %>%
#  group_by(EQUIPO) %>%
#  mutate(cont = ifelse(lag(AÑO,1) == (AÑO - 1), 1, 1)) %>%
#  mutate(cont = ifelse(is.na(cont), 1, cont),
#         contcum = cumsum(cont)) %>%
#  group_by(contcum) %>%
#  count() %>%
#  ungroup() %>%
#  arrange(desc(contcum)) %>%
#  mutate(pct = cumsum(n)/nrow(df)) %>%
#  ggplot(aes(contcum, pct)) +
#  geom_path() +
#  geom_point() +
#  scale_y_continuous(limits = c(0,1)) +
#  scale_x_continuous(breaks = 1:9) +
#  labs(title = nameFig("Continuidad de los datos")) +
#  theme_bw()
```

# Resultados
## Análisis de Componentes Principales (PCA)

La reducción de la dimensionalidad mediante la aplicación del análisis de componentes principales (PCA), permite explicar el 93,68% de la varianza del conjunto de datos originales a lo largo de 6 dimensiones. La matriz de correlación representada detalla las cargas de cada variable original sobre dichos factores, permitiendo su interpretación y etiquetado. Tras aplicar una rotación varimax sobre los componentes principales, se obtienen unos componentes rotados (RC) cuyas cargas o correlaciones con las variables originales los hacen más fáciles de interpretar. Por esta razón, se decidió utilizar la solución rotada antes que la original para entrenar la malla SOM.

El primer factor muestra una fuerte correlación negativa (r < -0,8) con los ingresos, la cifra de inmovilizado material, y el valor de mercado tanto de la plantilla actual como de la histórica reciente. Además, presenta una correlación negativa moderada (r < -0,5) con el gasto en fichajes y el porcentaje de victorias actual. En resumen, se puede interpretar que el primer componente rotado (RC1) se relaciona con el valor de los principales activos del equipo (estadio y jugadores), así como su capacidad para generar ingresos. Por su parte, el segundo componente rotado (RC2) está fuertemente correlacionado de manera negativa (r < -0,9) con el porcentaje de victorias actual, y en menor grado (r < -0,6) con la media de victorias en los últimos cinco años. El tercer componente rotado (RC3) también destaca por su fuerte correlación negativa (r < -0,8) con el EBIT generado por el club en la temporada actual. En contraste, el cuarto componente rotado (RC4) tiene una fuerte correlación positiva (r > 0,8) con el porcentaje medio de ocupación del estadio. El quinto componente rotado (RC5) está positivamente correlacionado con la capacidad total del estadio (r > 0,8) y con la cifra media de asistencia (r > 0,6). Finalmente, el sexto factor presenta una relación negativa con el ranking nacional actual y el de los últimos cinco años (r < -0,8). La tabla

```{r}
PCA <- df %>%
  select(where(is.numeric) & !all_of("AÑO")) %>%
  mutate(across(everything(), 
                winsorize, prob = 0.05)) %>%
  prcomp(., 
         scale. = T,
         rank. = 6) 

summary(PCA)[["importance"]] %>%
  as.data.frame() %>%
  select(1:6) %>%
  kable(format = "latex", 
        booktabs = TRUE,
        caption = nameTab("Resultado de PCA")) %>%
  kable_styling(latex_options = c("striped", "hold_position"))

scores <- as.array(scale(PCA$x))
rotation <- varimax(PCA$rotation)
rotation.matrix <- as.array(rotation$rotmat)
rot.scores <- as.array(scores %*% rotation.matrix) 
colnames(rot.scores) <- c(paste0("RC",1:6))


scores_corr <- df %>%
  select(where(is.numeric) & !all_of("AÑO")) %>%
  cor(scores)

rot.scores_corr <- df %>%
  select(where(is.numeric) & !all_of("AÑO")) %>%
  cor(rot.scores)

corrplot1 <- wrap_elements(~corrplot(scores_corr,
                                     tl.col = "black",
                                     method = 'color'))

corrplot2 <- wrap_elements(~corrplot(rot.scores_corr,
                                     tl.col = "black",
                                     method = 'color',
                                     tl.pos = "lt"))

corrplot1 + 
  ggtitle('a)') + 
  theme(plot.title = element_text(face = "bold")) +
  corrplot2 + 
  ggtitle('b)') +
  theme(plot.title = element_text(face = "bold")) +
  plot_annotation(nameFig("Cargas de variables originales sobre nuevos ejes"),
                caption = "Fuente: Elaboración propia")
```

```{r}
RC_labels <- c("ACTINGR","WINS","EBIT","OCUP","CAPAST","RANK")

data.frame(RC = c(1:6), 
           Etiqueta = RC_labels) %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE,
        caption = "Etiquetado de los componentes rotados") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r}
rot.scores <- rot.scores %>%
  as.data.frame() %>%
  mutate(across(all_of(c("RC1","RC2","RC5")), ~. * -1))
names(rot.scores) <- RC_labels
rownames(rot.scores) <- paste(df$EQUIPO,"|",df$AÑO)
```

## SOM

Se configuró la malla SOM con unas dimensiones de 15x15, para un total de 225 neuronas, equivalente a un 23% de las observaciones. Por su parte, para el entrenamiento se fijó un total del 10.000 iteraciones, con un learning rate de 0,01. Las Figura 3a y 3b representan los cambios en la distancia [formula] a lo largo de las iteraciones y la asignación de observaciones por neurona, respectivamente. Se observa la estabilización del modelo cerca de las 9.000 iteraciones, con una distancia media a la neurona más cercana inferior a 0,01. 

```{r}
trainingMatrix <- as.matrix(rot.scores)

xdim = 15
ydim = 15
set.seed(9546)
som_grid <- somgrid(xdim = xdim, ydim = ydim, topo="hexagonal")
som_model <- som(trainingMatrix, 
                 grid = som_grid, 
                 rlen = 10000, 
                 alpha = 0.01, 
                 keep.data = TRUE)

plot(som_model, type="changes", 
     main = "Evolución de la distancia entre neuronas")

for (i in 1:ncol(trainingMatrix)) {
  
  col_name <- colnames(getCodes(som_model))[i]
  plot(som_model, 
       type = "property", 
       property = getCodes(som_model)[,i], 
       main = col_name,
       palette.name = viridis_pal(option = "A",
                                  direction = -1,
                                  begin = 0.15,
                                  end = 1))
}
```

## Clustering Jerárquico

Tras aplicar agrupamiento jerárquico con encadenamiento de Ward sobre las neuronas, se decidió segmentar el mapa en 5 clústeres. 

```{r}
wss <- (nrow(som_model$codes[[1]])-1)*sum(apply(som_model$codes[[1]],2,var)) 
for (i in 2:10) {
  wss[i] <- sum(kmeans(som_model$codes[[1]], centers=i)$withinss)
}

plot(wss, main = "Knee plot")

tree <- hclust(object.distances(som_model , "codes"),
               method="ward")

K <- 5
som_cluster <- cutree(tree, k=K)
neuron_cluster <- data.frame(neuron = 1:(xdim*ydim),
                             cluster = as.factor(som_cluster))
table(som_cluster)

plot(som_model, 
     type = "mapping",
     bgcol = viridis(K)[som_cluster], 
     main = nameFig("Distribución y segmentación de malla SOM"))

df <- df %>%
  mutate(neuron = som_model$unit.classif) %>%
  left_join(neuron_cluster)

rot.scores <- rot.scores %>%
  mutate(neuron = som_model$unit.classif,
         EQUIPO = df$EQUIPO,
         AÑO = df$AÑO) %>%
  left_join(neuron_cluster)
```

## ANOVA

Tras la realización de pruebas de análisis de varianza (ANOVA), se encontraron diferencias significativas entre los clusters para cada uno de los 6 componentes principales para un nivel de significación del 1% (ver Tablas 6-11). Por lo cual, se procedió a realizar pruebas post-hoc (en concreto, TukeyHSD y Scheffe), pero sobre las variables originales relacionadas a cada uno de los componentes principales, con el fin de poder describir con mayor exactitud los clústers.

```{r}
anova_tests(rot.scores, RC_labels[1])$ANOVA[[1]] %>%
  as.data.frame() %>%
  kable(format = "latex", booktabs = TRUE, caption = "Análisis de varianza sobre ACTINGR") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

anova_tests(rot.scores, RC_labels[2])$ANOVA[[1]] %>%
  as.data.frame() %>%
  kable(format = "latex", booktabs = TRUE, caption = "Análisis de varianza sobre WINS") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

anova_tests(rot.scores, RC_labels[3])$ANOVA[[1]] %>%
  as.data.frame() %>%
  kable(format = "latex", booktabs = TRUE, caption = "Análisis de varianza sobre EBIT") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

anova_tests(rot.scores, RC_labels[4])$ANOVA[[1]] %>%
  as.data.frame() %>%
  kable(format = "latex", booktabs = TRUE, caption = "Análisis de varianza sobre OCUP") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

anova_tests(rot.scores, RC_labels[5])$ANOVA[[1]] %>%
  as.data.frame() %>%
  kable(format = "latex", booktabs = TRUE, caption = "Análisis de varianza sobre CAPAST") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

anova_tests(rot.scores, RC_labels[6])$ANOVA[[1]] %>%
  as.data.frame() %>%
  kable(format = "latex", booktabs = TRUE, caption = "Análisis de varianza sobre RANK") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

### Activos e ingresos (`r RC_labels[1]`)

```{r}
test_ing <- anova_tests(df, "INGRESOS")$Scheffe 
test_mv <- anova_tests(df, "MV")$Scheffe
test_mv5 <- anova_tests(df, "MV5")$Scheffe 
test_fic <- anova_tests(df, "FICHAJES")$Scheffe
test_mat <- anova_tests(df, "MATERIAL")$Scheffe
```

```{r bloxplots_ACTINGR, fig.width=7, fig.height=3}
#plot(som_model, 
#     type = "property", 
#     property = getCodes(som_model)[,1], 
#     main = colnames(getCodes(som_model))[1],
#     palette.name = viridis_pal(option = "A",
#                                direction = -1,
#                                begin = 0.15,
#                                end = 1))
#add.cluster.boundaries(som_model, som_cluster)

# Prueba sobre ingresos
test_ing %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por generación de ingresos") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# Prueba sobre valor de mercado de plantilla
test_mv %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por valor de plantilla") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# Prueba sobre valor de mercado de plantilla en los últimos 5 años
test_mv5 %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por valor de plantilla (últimos 5 años)") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# Prueba sobre inmovilizado material
test_mat %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por inmovilizado material") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

# Prueba sobre el gasto en fichajes
test_fic %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por gasto en fichajes") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=INGRESOS, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T,
                      name = NULL,
                      labels = paste("Clúster",1:K)) +
  labs(title = nameFig("Generación de ingresos por clúster"),
       x = NULL,
       caption = "Fuente: Elaboración propia") +
  theme_bw()


ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=MV, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T, guide="none") +
  labs(x = NULL) +
  theme_bw() +
ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=MV5, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T,
                     name = NULL,
                     labels = paste("Clúster",1:K)) +
  labs(x = NULL) +
  theme_bw() +
plot_annotation(nameFig("Valor de mercado de plantilla por clúster"),
                caption = "Fuente: Elaboración propia")

ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=FICHAJES, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T,
                     name = NULL,
                     labels = paste("Clúster",1:K)) +
  labs(title = nameFig("Gasto en fichajes por clúster"),
       x = NULL,
       caption = "Fuente: Elaboración propia") +
  theme_bw()

ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=MATERIAL, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T,
                     name = NULL,
                     labels = paste("Clúster",1:K)) +
  labs(title = nameFig("Cifra de inmovilizado material por clúster"),
       x = NULL,
       caption = "Fuente: Elaboración propia") +
  theme_bw()
```

### Porcentaje de victorias (`r RC_labels[2]`)

```{r}
test_win <- anova_tests(df, "WINPCT", pct = T)$Scheffe
test_win5 <- anova_tests(df, "WINPCT5", pct = T)$Scheffe
```

```{r boxplots_WINS, fig.width=7, fig.height=3}
#plot(som_model, 
#     type = "property", 
#     property = getCodes(som_model)[,2], 
#     main = colnames(getCodes(som_model))[2],
#     palette.name = viridis_pal(option = "A",
#                                direction = -1,
#                                begin = 0.15,
#                                end = 1))
#add.cluster.boundaries(som_model, som_cluster)

test_win %>%
  as.data.frame() %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por porcentaje de victorias") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

test_win5 %>%
  as.data.frame() %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por porcentaje de victorias (últimos 5 años)") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=WINPCT, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T, guide="none") +
  labs(x = NULL) +
  theme_bw() +
ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=WINPCT5, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T,
                     name = NULL,
                     labels = paste("Clúster",1:K)) +
  labs(x = NULL) +
  theme_bw() +
plot_annotation(nameFig("Porcentaje de victorias por clúster"),
                caption = "Fuente: Elaboración propia")
```

### Rentención de ingresos (`r RC_labels[3]`)

```{r}
test_ebit <- anova_tests(df, "EBIT")$Scheffe
```


```{r boxplot_EBIT, fig.width=7, fig.height=3}
#plot(som_model, 
#     type = "property", 
#     property = getCodes(som_model)[,3], 
#     main = colnames(getCodes(som_model))[3],
#     palette.name = viridis_pal(option = "A",
#                                direction = -1,
#                                begin = 0.15,
#                                end = 1))
#add.cluster.boundaries(som_model, som_cluster)

test_ebit %>%
  as.data.frame() %>%
  kable(format = "latex", 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por EBIT") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=EBIT, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T,
                      name = NULL,
                      labels = paste("Clúster",1:K)) +
  labs(title = nameFig("Retención de beneficio (EBIT) por clúster"),
       x = NULL,
       caption = "Fuente: Elaboración propia") +
  theme_bw()
```

### Ocupación del estadio (`r RC_labels[4]`)

```{r}
test_ocu <- anova_tests(df, "OCUPACION", pct = T)$Scheffe
```


```{r, boxplot_OCUP,  fig.width=7, fig.height=3}
#plot(som_model, 
#     type = "property", 
#     property = getCodes(som_model)[,4], 
#     main = colnames(getCodes(som_model))[4],
#     palette.name = viridis_pal(option = "A",
#                                direction = -1,
#                                begin = 0.15,
#                                end = 1))
#add.cluster.boundaries(som_model, som_cluster)
test_ocu  %>%
  as.data.frame() %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por ocupación del estadio") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=OCUPACION, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T,
                      name = NULL,
                      labels = paste("Clúster",1:K)) +
  labs(title = nameFig("Porcentaje de ocupación del estadio por clúster"),
       x = NULL,
       caption = "Fuente: Elaboración propia") +
  theme_bw()
```

### Masa de espectadores (`r RC_labels[5]`)

```{r}
test_cap <- anova_tests(df, "CAPACIDAD")$Scheffe
test_ast <- anova_tests(df, "ASISTENCIA")$Scheffe
```


```{r boxplot_CAPAST, fig.width=7, fig.height=3}
plot(som_model, 
     type = "property", 
     property = getCodes(som_model)[,5], 
     main = colnames(getCodes(som_model))[5],
     palette.name = viridis_pal(option = "A",
                                direction = -1,
                                begin = 0.15,
                                end = 1))

test_cap  %>%
  as.data.frame() %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por capacidad máxima del estadio") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

test_ast  %>%
  as.data.frame() %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por asistencia al estadio") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=CAPACIDAD, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T, guide="none") +
  labs(x = NULL) +
  theme_bw() +
ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=ASISTENCIA, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T,
                      name = NULL,
                      labels = paste("Clúster",1:K)) +
  scale_y_continuous(limits = c(0,100000)) +
  labs(x = NULL) +
  theme_bw() +
plot_annotation(nameFig("Capacidad total y asistencia al estadio por clúster"),
                caption = "Fuente: Elaboración propia")
```

### Ranking nacional (`r RC_labels[6]`)

```{r}
test_rnk <- anova_tests(df, "RANKNAC")$Scheffe
test_rnk5 <- anova_tests(df, "RANKNAC5")$Scheffe
```

```{r boxplot_RANK, fig.width=7, fig.height=3}
#plot(som_model, 
#     type = "property", 
#     property = getCodes(som_model)[,6], 
#     main = colnames(getCodes(som_model))[6],
#     palette.name = viridis_pal(option = "A",
#                                direction = -1,
#                                begin = 0.15,
#                                end = 1))
#add.cluster.boundaries(som_model, som_cluster)

test_rnk  %>%
  as.data.frame() %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por ranking nacional") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

test_rnk5  %>%
  as.data.frame() %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE, 
        caption = "Grupos diferenciados por ranking nacional (últimos 5 años)") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=RANKNAC, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T, guide="none") +
  labs(x = NULL) +
  theme_bw() +
ggplot(df) + 
  geom_boxplot(aes(x=cluster, 
                   y=RANKNAC5, 
                   fill=cluster),
               color = "black") +
  scale_fill_viridis(discrete = T,
                      name = NULL,
                      labels = paste("Clúster",1:K)) +
  labs(x = NULL) +
  theme_bw() +
plot_annotation(nameFig("Ranking nacional por clúster"),
                caption = "Fuente: Elaboración propia")
```

## Descripción y etiquetado de los clústers

```{r}
cluster_labels <- c("Distress B",
                    "Élite A-",
                    "Moderados",
                    "Distress A",
                    "Élite A+")

df$cluster <- factor(df$cluster,
                     levels = c(1,2,3,4,5),
                     labels = cluster_labels)
```

- **Clúster 1 - `r cluster_labels[1]`**: Este grupo incluye equipos que generalmente tienen los peores rendimientos tanto financieros como deportivos. Tienen los ingresos más bajos, con una media de €23.31 millones. La inversión en fichajes es mínima, con un promedio de €4.32 millones, y también presentan una baja capacidad de estadio y asistencia. En términos de desempeño deportivo, muestran los peores rankings nacionales y un porcentaje de victorias bajo. Su EBIT también es negativo, indicando pérdidas consistentes.

- **Clúster 2 -  `r cluster_labels[2]`**: Este clúster agrupa a equipos de alto nivel que no alcanzan el rendimiento de los equipos de élite absoluta. Tienen altos ingresos, en promedio €256.95 millones, y una considerable inversión en fichajes de €101.97 millones. Estos equipos también disfrutan de una alta ocupación del estadio (promedio 84.1%) y un EBIT positivo. Su rendimiento deportivo es notable, con un porcentaje de victorias de alrededor de 44.35%.

- **Clúster 3 - `r cluster_labels[3]`**: Formado por equipos con un rendimiento y estabilidad medios, a menudo incluye los equipos recién ascendidos a primera división. Tienen ingresos moderados (aproximadamente €80.69 millones) y una inversión en fichajes media, unos €27.11 millones. Aunque los porcentajes de ocupación y asistencia al estadio son intermedios, estos equipos muestran una mejora en sus rankings nacionales en los últimos 5 años, sugiere que su rendimiento deportivo y financiero ha ido mejorando.

- **Clúster 4 - `r cluster_labels[4]`**: Equipos que, aunque tienen ingresos bajos-moderados (alrededor de €81.01 millones), su situación financiera y deportiva está en declive. Presentan pérdidas en EBIT, ocupación baja del estadio y niveles reducidos de asistencia. La inversión en fichajes es similar a la del clúster 3, pero su rendimiento deportivo ha disminuido en comparación con sus propias marcas históricas.

- **Clúster 5 - `r cluster_labels[5]`**: Los mejores equipos en términos de desempeño financiero y deportivo. Tienen los ingresos más altos, promediando €523.12 millones, y una inversión significativa en fichajes de €133.7 millones. También presentan las capacidades y asistencias más altas en los estadios, con una ocupación promedio del 77.94%. Líderes en el ranking nacional, muestran un rendimiento deportivo excepcional con el mayor porcentaje de victorias (62.4%) y el EBIT más alto.

## Múltiplos de ingresos

El siguiente paso consiste en la estimación de los ratios EV/Ingresos para cada clúster. Esta estimación se basa en las transacciones encontradas sobre las observaciones de los equipos. Para ello, se emplearán tres metodologías de estimación distintas: 1) la media del valor de transacción sobre ingresos por clúster, 2) la mediana, y 3) una media ponderada por distancia. Esta última técnica toma en consideración la distancia existente entre la neurona correspondiente a cada observación y la neurona asignada a cada transacción dentro del clúster. Esta triangulación permitirá una visión más precisa y robusta de la valoración económica de los equipos, proporcionando una base sólida para su valoración. 

```{r}
ratios <- df %>%
  left_join(Deals, by = c("EQUIPO","AÑO")) %>%
  filter(!is.na(ID)) %>%
  mutate(VALOR = VALOR*100/PART,
         RATIO = VALOR/INGRESOS) %>%
  group_by(Cluster = cluster) %>%
  summarise(`Nº transacciones` = n(), 
            `% media` = mean(PART),
            `Ratio medio` = mean(RATIO),
            `Valor medio` = mean(RATIO),
            `Ratio mediano` = median(RATIO),
            `Valor mediano` = median(RATIO))

ratios %>%
  kable(format = ifelse(knitr::is_latex_output(), "latex", "html"), 
        booktabs = TRUE,
        caption = nameTab("Transacciones y ratios por clúster")) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```



```{r}
ratios <- Deals %>%
  inner_join(df, by = c("EQUIPO","AÑO")) %>%
  mutate(RATIO = (VALOR*100/PART)/INGRESOS) %>%
  filter(!is.na(RATIO))

distance_matrix <- df %>%
  select(where(is.numeric) & !all_of("AÑO")) %>%
  scale() %>%
  dist("euclidean") %>%
  as.matrix()

dist_ratios <- df %>%
  select(neuron, cluster) %>%
  distinct() %>%
  rowwise() %>%
  mutate(NEURON_RATIO = neuron_distance_ratio(neuron,cluster))
