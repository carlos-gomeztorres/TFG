---
title: "Pre-processing"
output: html_notebook
---

## Deals

```{r}
library(readxl)
library(tidyverse)
library(viridis)
library(lubridate)
library(rio)

deals <- read_xlsx("./datos/Deals.xlsx", sheet = 1) %>% 
  select(-`...1`) %>%
  rename(`ID Comprador` = `Acquiror BvD ID number`,
         Comprador = `Acquiror name`,
         `Tipo Comprador` = `Acquiror entity type`,
         `País Comprador` = `Acquiror country`,
         `Región Comprador` = `Acquiror world region`,
         `ID Equipo` = `Target BvD ID number`,
         Equipo = `Target name`,
         `País Equipo` = `Target country`,
         `Región Equipo` = `Target world region`,
         Fecha = `Last deal status date`,
         Stake = `Acquired stake (%)`,
         Volumen = `Deal value\nmil EUR`,
         ) %>%
  mutate(Año = year(Fecha),
         `t - 1` = year(Fecha) - 1,
         Stake = as.numeric(Stake),
         `Intervalo Stake` = cut(Stake, 
                                breaks = c(-Inf, 20, 40, 60, 80, Inf), 
                                labels = c("0-20%", "21-40%", "41-60%", "61-80%", "81-100%")),
         Volumen = as.numeric(Volumen)) %>%
  filter(Año > 2000) %>%
  filter(!is.na(Stake)) %>%
  filter(!is.na(Volumen)) %>%
  select(-starts_with("Vendor"))



group_regions <- function(regions_column) {
  
  regiones <- c("Europa (Oeste)", 
              "América del Norte", 
              "Asia", 
              "África", 
              "América del Sur", 
              "Oceania", 
              "Oriente Medio", 
              "Europa (Este)", 
              "Other")
  
  grouped_regions <- factor(ifelse(grepl("Western Europe", regions_column), "Europa (Oeste)",
                           ifelse(grepl("North America", regions_column), "América del Norte",
                           ifelse(grepl("Far East|Central Asia|ASEAN", regions_column), "Asia",
                           ifelse(grepl("Africa", regions_column), "África",
                           ifelse(grepl("South and Central America", regions_column), "América del Sur",
                           ifelse(grepl("Oceania", regions_column), "Oceania",
                           ifelse(grepl("Middle East", regions_column), "Oriente Medio",
                           ifelse(grepl("Eastern Europe|Balkan States", regions_column), "Europa (Este)",
                           ifelse(is.na(regions_column), NA, "Other"))))))))), levels = regiones)
  
  return(grouped_regions)
}

deals$`Continente Comprador` <- group_regions(deals$`Región Comprador`)
deals$`Continente Equipo` <- group_regions(deals$`Región Equipo`)
```

## Activo

```{r}
activo <- read_xlsx("./datos/Equipos/Activos (2000 - 2024).xlsx", sheet = 1)


activo[activo == "n.d."] <- NA

activo <- activo %>%
  rename(Equipo = `Nombre empresaAlfabeto latino`,
         `ID Equipo` = `Número de identificación BvD`,
         row = `...1`) 

cols_to_pivot <- setdiff(names(activo), c("Equipo", "ID Equipo","row","País", "Standardized country"))
activo <- activo %>%
  pivot_longer(cols = all_of(cols_to_pivot), names_to = "columna", values_to = "Valor") %>%
  mutate(
    Cuenta = gsub("\\s+EUR\\s+\\d+", "", columna),
    Año = as.numeric(gsub(".*\\b(\\d{4})\\b.*", "\\1", columna)),
    Valor = as.numeric(Valor)/1e6
  )  %>%
  pivot_wider(names_from = "Cuenta", values_from = "Valor") %>%
  select(`ID Equipo`,
         Año,
        # Activos
        `Activos fijos`,
        `Activo circulante`,
        `Activos totales`,
        `Deudores`,
        `Efectivo y equivalentes de efectivo`,
        `Otros activos corrientes`)


```

## Pasivo y Patrimonio Neto

```{r}
pasivo <- read_xlsx("./datos/Equipos/Pasivo y Patrimonio (2000 - 2024).xlsx", sheet = 1)


pasivo[pasivo == "n.a."] <- NA

pasivo <- pasivo %>%
  rename(Equipo = `Nombre empresaAlfabeto latino`,
         `ID Equipo` = `Número de identificación BvD`,
         row = `...1`) 

cols_to_pivot <- setdiff(names(pasivo), c("Equipo", "ID Equipo","row","País", "Standardized country"))

pasivo <- pasivo %>%
  pivot_longer(cols = all_of(cols_to_pivot), names_to = "columna", values_to = "Valor") %>%
  mutate(
    Cuenta = gsub("\\s+EUR\\s+\\d+", "", columna),
    Año = as.numeric(gsub(".*\\b(\\d{4})\\b.*", "\\1", columna)),
    Valor = as.numeric(Valor)/1e6
  )  %>%
  select(-c(Equipo, row,columna)) %>%
  pivot_wider(names_from = "Cuenta", values_from = "Valor") %>%
  select(`ID Equipo`,
         Año,
        # Pasivos
        `Fondos de los accionistas`, 
        `Pasivos no corrientes`,
        `Deudas a corto plazo`,
        `Total pasivo`)
```


## Pérdidas y Ganancias

```{r}
PyG <- read_xlsx("./datos/Equipos/PyG (2000 - 2024).xlsx", sheet = 1)


PyG[PyG == "n.a."] <- NA

PyG <- PyG %>%
  rename(Equipo = `Nombre empresaAlfabeto latino`,
         `ID Equipo` = `Número de identificación BvD`,
         row = `...1`) 

cols_to_pivot <- setdiff(names(PyG), c("Equipo", "ID Equipo","row","País", "Standardized country"))

PyG <- PyG %>%
  pivot_longer(cols = all_of(cols_to_pivot), names_to = "columna", values_to = "Valor") %>%
  mutate(
    Cuenta = gsub("\\s+EUR\\s+\\d+", "", columna),
    Año = as.numeric(gsub(".*\\b(\\d{4})\\b.*", "\\1", columna)),
    Valor = as.numeric(Valor)/1e6
  )  %>%
  select(-c(Equipo, row,columna)) %>%
  pivot_wider(names_from = "Cuenta", values_from = "Valor") %>%
  select(`ID Equipo`,
         Año,
        # PyG
        `Ingresos explotación (Cifra ventas)`, 
        `P/G operacionales [=EBIT]`,
        Impuestos,
        `Beneficio bruto`)
```


## Análisis ratios

```{r, warning=F, message = F}
ratios <- full_join(activo, pasivo, by = c("ID Equipo","Año")) %>%
  full_join(PyG,by = c("ID Equipo","Año")) %>%
  mutate(across(everything(), ~ ifelse(. == 0, 0.00001, .))) %>%
  group_by(`ID Equipo`, Año) %>%
  summarise(# Equilibrio
            FM = round(`Fondos de los accionistas` + `Pasivos no corrientes` - `Activos fijos`,2),
            Equilibrio = round((`Fondos de los accionistas` + `Pasivos no corrientes`)/`Activos fijos`,2),
            `Plazo FM` = round((FM / `Ingresos explotación (Cifra ventas)`)*360,2),
            #CBF = (`Fondos de los accionistas` + `Pasivos no corrientes`) !!!
            # Resultados
            `RC` = round(`P/G operacionales [=EBIT]`/`Ingresos explotación (Cifra ventas)`,2),
            `REB` = round(`P/G operacionales [=EBIT]`/`Activos totales`,2),
            `RA` = round(`Ingresos explotación (Cifra ventas)`/`Activos totales`,2),
            `ROA` = round((`P/G operacionales [=EBIT]` - Impuestos)/`Activos totales`,2),
            # Solvencia a corto plazo:
            Disponibilidad = round(`Efectivo y equivalentes de efectivo`/`Deudas a corto plazo`,2),
            `Acid Test` = round((`Deudores` + `Otros activos corrientes`)/`Deudas a corto plazo`,2), 
            Liquidez = round(`Activo circulante`/`Deudas a corto plazo`,2),
            # Solvencia a largo plazo:
            Consistencia = round(`Activos fijos`/`Pasivos no corrientes`,2),
            Apalancamiento = round(`Total pasivo`/`Fondos de los accionistas`,2),
            `Deuda L/P` = round(`Pasivos no corrientes`/`Fondos de los accionistas`,2),
            `Deuda C/P` = round(`Deudas a corto plazo`/`Fondos de los accionistas`,2))
```


## Join de toda la información
```{r}
df <- deals %>%
  inner_join(activo,
            by = c("ID Equipo" = "ID Equipo", 
                           "t - 1" = "Año")) %>%
  inner_join(pasivo,
            by = c("ID Equipo" = "ID Equipo", 
                           "Año" = "Año"),
            suffix = c(" Activo", " Pasivo")) %>%
  inner_join(PyG,
            by = c("ID Equipo" = "ID Equipo", 
                           "Año" = "Año")) %>%
  inner_join(ratios,
             by = c("ID Equipo" = "ID Equipo", 
                           "Año" = "Año")) %>%
  # Quitamos todas aquellas filas sin información completa financiera
  filter_if(is.numeric, all_vars(!is.na(.))) %>%
  filter(!grepl("CAPITAL", toupper(`Deal type`), fixed = T)) %>%
  filter(`Continente Equipo` == "Europa (Oeste)") %>%
  filter(Año < 2023)

# El Manchester United es el único equipo en Islas Caimán. Lo corregimos.
df$`Continente Equipo`[df$`ID Equipo` == "KY21506EX"] <- "Europa (Oeste)"
df$`País Equipo`[df$`ID Equipo` == "KY21506EX"] <- "United Kingdom"

df$vol_to_stk <- df$Volumen/df$Stake
```

# Análisis exploratorio
## Completitud de la información
```{r}
df %>%
  group_by(Año) %>%
  summarise(n=n()) %>%
  ggplot(aes(Año,n)) +
  geom_path() +
  geom_smooth(se = F, linetype = "dotted", color = "darkgoldenrod1") +
  theme_bw()
```


```{r}
df %>%
  group_by(pais = `País Equipo`) %>%
  summarise(n = n()) %>%
  slice_max(order_by = n, n = 15) %>%
  ggplot(aes(reorder(pais, n), n)) +
  geom_bar(fill = "lightblue", stat = "identity") +
  coord_flip() +
  labs(title = "Nº de transacciones",
       x = NULL,
       y = NULL) +
  theme_bw()

df %>%
  group_by(pais = `País Equipo`) %>%
  summarise(n_deals = n(),
            n_equipos = length(unique(`ID Equipo`)),
            stake_medio = mean(Stake),
            volumen_medio = mean(Volumen),
            `n_deals/n_equipos` = n_deals/n_equipos) %>%
   slice_max(order_by = n_deals, n = 15)
  
df %>%
  group_by(continente = `Continente Equipo`) %>%
  summarise(n_deals = n(),
            n_equipos = length(unique(`ID Equipo`)),
            volumen_medio = mean(Volumen),
            `n_deals/n_equipos` = n_deals/n_equipos)
```

```{r}
table(df$`Continente Comprador`,df$`Tipo Comprador`)

df %>%
  group_by(t = Año) %>%
  summarise(vol = mean(Volumen)) %>%
  ggplot(aes(t, vol)) +
  geom_path() +
  labs(title = "Volumen medio anual") +
  theme_bw()

df %>%
  group_by(t = Año) %>%
  summarise(stk = mean(Stake)) %>%
  ggplot(aes(t, stk)) +
  geom_path() +
  geom_smooth(se = F, method = "lm") +
  theme_bw()
```

```{r}
library(corrplot)

df %>%
  select_if(is.numeric) %>%
  select(-c(Año,`t - 1`)) %>%
  cor() %>%
  corrplot(tl.cex = 0.5)

df %>%
  filter(`País Equipo` %in% c("Spain","Germany","Italy","France","United Kingdom")) %>%
  select_if(is.numeric) %>%
  select(-c(Año,`t - 1`)) %>%
  cor() %>%
  corrplot(tl.cex = 0.5)

df %>%
  filter(!`País Equipo` %in% c("Spain","Germany","Italy","France","United Kingdom")) %>%
  select_if(is.numeric) %>%
  select(-c(Año,`t - 1`)) %>%
  cor() %>%
  corrplot(tl.cex = 0.5)

```

```{r}
# This will perform a PCA, with a possibility of rotation.
Extract_Factors <- function(data, rank, rotation = F) {
  
  PCA_Full <- prcomp(data, 
                scale. = T,
                rank. = rank) 
  
  print(summary(PCA_Full))
  scores <- as.array(scale(PCA_Full$x))
  
  if (rotation) {
    rotation <- varimax(PCA_Full$rotation)
    rot.scores <- as.array(scores %*% rotation$rotmat)
    
    factors <- rot.scores
    corrplot(cor(data,rot.scores))
    
  } else {
    factors <- scores
    corrplot(t(cor(data,scores)))
  }
  
  return(factors)
}

# This will tell us the variables that are mostly correlated to each new factor

studyFactors <- function(pca_data, factors) {
  
  correlations <- as.data.frame(cor(pca_data,factors))
  
  correlations$var <- row.names(correlations)
  
  for (i in 1:(ncol(correlations)-1)) {
    
    table <- correlations %>%
      mutate(color = correlations[[i]]>=0,
            abs = abs(correlations[[i]])) %>%
      top_n(n=20,wt=abs) %>%
      mutate(tag = 1:20) %>% 
      ggplot() +
      geom_col(aes(x=reorder(var,abs),y=abs,fill=color)) +
      geom_hline(yintercept = 0.7, linetype = "dashed") +
      scale_fill_manual(name = "Correlation sign",
                        labels = c("Negative","Positive"),
                        values = c("Red","Blue")) +
      scale_y_continuous(limits = c(0,1)) +
      labs(x = "Original Variable",
           y = "Absolute Value of correlation") +
      coord_flip() +
      theme_bw()
     
    print(table)
      
  }
}

PCA_Analysis <- function(data, rank, rotation, cor = 0.7) {
  
  data <- data[,apply(data, 2, var, na.rm=TRUE) != 0]
  
  factors <- Extract_Factors(data, rank, rotation)
  studyFactors(data, factors)
  
  return(factors)
}
```

# PCA sin rotación
```{r}
df_PCA <- df %>%
  select_if(is.numeric) %>%
  select(-c(Año,`t - 1`,vol_to_stk,Volumen,Stake)) %>%
  PCA_Analysis(rank = 7, rotation = F)
```

# PCA con rotación
```{r}
df_PCA <- df %>%
  select_if(is.numeric) %>%
  select(-c(Año,`t - 1`,vol_to_stk,Volumen,Stake)) %>%
  PCA_Analysis(rank = 7, rotation = T)
```

Resultados interesantes. Posibles nombres de factores de acuerdo a las correlaciones lineales con las variables originales:
- Factor 1: Tamaño
- Factor 2: Solvencia a corto plazo
- Factor 3: Nivel de deuda o apalancamiento (negativo)
- Factor 4: Rentabilidad sobre activos (negativo)
- Factor 5: Carga de la deuda a largo plazo
- Factor 6: Generación de ingresos (negativo)
- Factor 7: Activos corrientes

```{r}

factores <- as.data.frame(df_PCA)

names(factores) <- c("Tamaño",
                   "Solvencia a corto plazo",
                   "Apalancamiento",
                   "Rentabilidad sobre activos",
                   "Carga de la deuda a largo plazo",
                   "Generación de ingresos",
                   "Activos corrientes")
```
```{r}
table(df$`País Equipo`)
```

