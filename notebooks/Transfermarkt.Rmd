---
title: "Construcción de conjunto de datos"
author: "Carlos Eduardo Gómez-Torres"
date: "`r Sys.Date()`"
output: html_document
---

# Carga de paquetes
```{r}
library(rio)
library(here)
library(tidyverse)
library(zoo)
source(here('./scripts/calculate_rank.R'))
calculate_moving_average <- function(x) {
  rollapply(x, width = 5, FUN = mean, align = "right", fill = NA)
}
```

# Datos deportivos
```{r}
Transfers <- import(here('./data/raw/Transfers.xlsx'))
Ranking <- import(here('./data/raw/Ranking.xlsx'))
Attendance <- import(here('./data/raw/Attendance.xlsx'))
Estadio <- import(here('./data/raw/Estadio.xlsx'))
temporadas_años <- data.frame(AÑO = 2009:2022,
                              TEMPORADA = c("09/10","10/11","11/12",
                                            "12/13","13/14","14/15","15/16",
                                            "16/17","17/18","18/19","19/20",
                                            "20/21","21/22","22/23"))
Equipos <- import(here('./data/aux/Equipos.xlsx'))

Transfermarkt <- Attendance %>%
  inner_join(temporadas_años, by = "TEMPORADA") %>%
  inner_join(Transfers, by = c("TRANSFERMARKT_HANDLE","AÑO")) %>%
  inner_join(Estadio, by = "TRANSFERMARKT_HANDLE") %>%
  inner_join(Equipos %>% select("EQUIPO","TRANSFERMARKT_HANDLE","TRANSFERMARKT_ID","PAIS"), 
             by = c("TRANSFERMARKT_HANDLE")) %>%
  left_join(Ranking, by = c("TRANSFERMARKT_HANDLE","AÑO","PAIS")) %>%
  filter(AÑO < FIN, AÑO >= CONSTREST)
```

```{r}
Transfermarkt <- Transfermarkt %>%
  mutate(WINPCT = G / (G + E + P),
         OCUPACION = ASISTENCIA / CAPACIDAD,
         ANTEST = 2024 - CONSTREST)

Transfermarkt <- Transfermarkt %>%
  rowwise() %>% 
  mutate(RANKNAC = calculate_rank(PAIS, DIV, POSIC, AÑO)) %>%
  ungroup() 

Transfermarkt <- Transfermarkt %>%
  group_by(EQUIPO) %>%
  arrange(AÑO) %>%
  mutate(WINPCT5 = calculate_moving_average(WINPCT),
         MV5  = calculate_moving_average(MV),
         NETTRANSF = calculate_moving_average(NETTRANSF),
         RANKNAC5 = calculate_moving_average(RANKNAC)) %>%
  ungroup()
```

```{r}
Transfermarkt <- Transfermarkt %>%
  select(-c(G,
            E,P,PTS,PAIS,FIN,DIV,POSIC,TRANSFERMARKT_ID,
            TRANSFERMARKT_HANDLE,TEMPORADA,CONSTREST)) %>%
  filter(complete.cases(.))

export(Transfermarkt, here('./data/processed/Transfermarkt.xlsx'), rowNames = F)
```

